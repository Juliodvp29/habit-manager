<ion-header class="ion-no-border">
  <ion-toolbar class="px-4 bg-white dark:bg-neutral-900">
    <ion-buttons slot="start">
      <ion-button (click)="goBack()" class="text-neutral-700 dark:text-neutral-300">
        <ion-icon slot="icon-only" name="chevron-back-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title class="text-neutral-900 dark:text-neutral-50">
      Notificaciones
    </ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="markAllAsRead()" [disabled]="unreadCount() === 0"
        class="text-primary-600 dark:text-primary-400">
        <ion-icon slot="icon-only" name="checkmark-done-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Segmento de filtros -->
  @if (hasNotifications()) {
  <ion-toolbar class="px-4 bg-neutral-50 dark:bg-neutral-800">
    <ion-segment [value]="filterType()" (ionChange)="onFilterChange($event)" class="w-full">
      <ion-segment-button value="all">
        <ion-label>Todas</ion-label>
        <ion-badge class="ml-2">{{ notifications().length }}</ion-badge>
      </ion-segment-button>
      <ion-segment-button value="unread">
        <ion-label>Sin leer</ion-label>
        @if (unreadCount() > 0) {
        <ion-badge class="ml-2">{{ unreadCount() }}</ion-badge>
        }
      </ion-segment-button>
      <ion-segment-button value="read">
        <ion-label>Leídas</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
  }
</ion-header>

<ion-content class="bg-neutral-50 dark:bg-neutral-950">
  <!-- Refresher -->
  <ion-refresher slot="fixed" (ionRefresh)="onRefresh($event)" [disabled]="isLoading()">
    <ion-refresher-content pullingIcon="chevron-down-circle-outline" pullingText="Deslizar para actualizar"
      refreshingSpinner="crescent">
    </ion-refresher-content>
  </ion-refresher>

  <!-- Loading state -->
  @if (isLoading() && notifications().length === 0) {
  <div class="flex items-center justify-center py-20">
    <div class="text-center">
      <ion-spinner name="crescent" class="w-12 h-12 text-primary-500 mb-4"></ion-spinner>
      <p class="text-neutral-600 dark:text-neutral-400">Cargando notificaciones...</p>
    </div>
  </div>
  }

  <!-- Empty state -->
  @else if (!hasNotifications()) {
  <div class="flex flex-col items-center justify-center py-20 px-6">
    <div class="text-center">
      <div
        class="w-20 h-20 bg-neutral-100 dark:bg-neutral-800 rounded-full flex items-center justify-center mx-auto mb-4">
        <ion-icon name="notifications-outline" class="text-4xl text-neutral-400"></ion-icon>
      </div>
      <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-50 mb-2">
        No hay notificaciones
      </h3>
      <p class="text-sm text-neutral-600 dark:text-neutral-400 mb-6">
        Cuando recibas notificaciones, aparecerán aquí
      </p>
      <ion-button (click)="loadNotifications()" fill="outline" shape="round">
        <ion-icon name="refresh-outline" slot="start"></ion-icon>
        Actualizar
      </ion-button>
    </div>
  </div>
  }

  <!-- Empty filter state -->
  @else if (!hasFilteredNotifications()) {
  <div class="flex flex-col items-center justify-center py-20 px-6">
    <div class="text-center">
      <ion-icon name="filter-outline" class="text-6xl text-neutral-300 dark:text-neutral-700 mb-4">
      </ion-icon>
      <h3 class="text-lg font-semibold text-neutral-900 dark:text-neutral-50 mb-2">
        @switch (filterType()) {
        @case ('unread') {
        No hay notificaciones sin leer
        }
        @case ('read') {
        No hay notificaciones leídas
        }
        @default {
        No hay notificaciones
        }
        }
      </h3>
      <p class="text-sm text-neutral-600 dark:text-neutral-400">
        Cambiar filtro para ver otras notificaciones
      </p>
    </div>
  </div>
  }

  <!-- Notifications list -->
  @else {
  <div class="space-y-2 px-2 py-4">
    @for (notification of filteredNotifications(); track notification.id) {
    <ion-item-sliding [attr.data-id]="notification.id">
      <ion-item (click)="viewNotification(notification)"
        class="bg-white dark:bg-neutral-900 rounded-2xl mb-2 shadow-sm hover:shadow-md transition-shadow cursor-pointer"
        [class.border-l-4]="!notification.isRead" [class.border-l-primary-500]="!notification.isRead" button>

        <!-- Avatar con indicador de leído -->
        <div slot="start" class="relative mr-3">
          <div class="w-12 h-12 rounded-full flex items-center justify-center flex-shrink-0"
            [ngClass]="'bg-' + getNotificationColor(notification.type) + '-100 dark:bg-' + getNotificationColor(notification.type) + '-900/30'">
            @switch (notification.type) {
            @case ('streak') {
            <ion-icon name="flame-outline" class="text-xl text-orange-500"></ion-icon>
            }
            @case ('achievement') {
            <ion-icon name="checkmark-circle-outline" class="text-xl text-green-500"></ion-icon>
            }
            @case ('reminder') {
            <ion-icon name="time-outline" class="text-xl text-blue-500"></ion-icon>
            }
            @case ('motivational') {
            <ion-icon name="heart-outline" class="text-xl text-red-500"></ion-icon>
            }
            @case ('security') {
            <ion-icon name="shield-outline" class="text-xl text-yellow-600"></ion-icon>
            }
            @case ('warning') {
            <ion-icon name="warning-outline" class="text-xl text-orange-600"></ion-icon>
            }
            @default {
            <ion-icon name="notifications-outline" class="text-xl text-neutral-500"></ion-icon>
            }
            }
          </div>
          @if (!notification.isRead) {
          <div class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full"></div>
          }
        </div>

        <!-- Content -->
        <div class="flex-1 min-w-0">
          <!-- Title y badge de tipo -->
          <div class="flex items-center gap-2 mb-1">
            <h3 class="font-semibold text-neutral-900 dark:text-neutral-50 truncate"
              [class.font-bold]="!notification.isRead">
              {{ notification.title }}
            </h3>
            @if (!notification.isRead) {
            <span
              class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-400 flex-shrink-0">
              Nuevo
            </span>
            }
          </div>

          <!-- Message -->
          <p class="text-sm text-neutral-600 dark:text-neutral-400 line-clamp-2 mb-2">
            {{ notification.message }}
          </p>

          <!-- Metadata -->
          <div class="flex items-center gap-3 text-xs text-neutral-500 dark:text-neutral-400">
            <span class="flex items-center gap-1">
              <ion-icon name="time-outline"></ion-icon>
              {{ getRelativeTime(notification.createdAt) }}
            </span>
            @if (notification.isRead) {
            <span class="flex items-center gap-1">
              <ion-icon name="checkmark-done-outline"></ion-icon>
              Leída
            </span>
            }
          </div>
        </div>

        <!-- Right indicator -->
        <div slot="end" class="flex items-center">
          @if (!notification.isRead) {
          <div class="w-2 h-2 rounded-full bg-primary-500 mr-3"></div>
          }
          <ion-icon name="chevron-forward-outline" class="text-neutral-400"></ion-icon>
        </div>
      </ion-item>

      <!-- Sliding options -->
      <ion-item-options side="end">
        @if (!notification.isRead) {
        <ion-item-option (click)="markAsRead(notification)" color="primary">
          <ion-icon slot="icon-only" name="checkmark-outline"></ion-icon>
        </ion-item-option>
        }
        <ion-item-option (click)="deleteNotification(notification)" color="danger">
          <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
        </ion-item-option>
      </ion-item-options>
    </ion-item-sliding>
    }
  </div>
  }

  <!-- Safe area bottom for tab navigation -->
  <div class="h-20"></div>
</ion-content>